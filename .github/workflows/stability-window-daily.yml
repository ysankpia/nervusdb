name: Stability Window Daily

on:
  schedule:
    - cron: "30 4 * * *"
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: stability-window-daily-${{ github.ref }}
  cancel-in-progress: true

jobs:
  stability-window:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build strict stability window report
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p artifacts/tck
          DATE_UTC="$(date -u +%F)"
          LOG_FILE="artifacts/tck/stability-window-${DATE_UTC}.log"
          set +e
          bash scripts/stability_window.sh \
            --mode strict \
            --date "${DATE_UTC}" \
            --github-repo "${GITHUB_REPOSITORY}" \
            --github-token-env GITHUB_TOKEN \
            >"${LOG_FILE}" 2>&1
          rc=$?
          set -e
          echo "${rc}" > "artifacts/tck/stability-window-${DATE_UTC}.rc"
          if [[ "${rc}" -ne 0 ]]; then
            echo "[stability-window-daily] window not yet satisfied (rc=${rc})"
          else
            echo "[stability-window-daily] window satisfied"
          fi

      - name: Upload stability artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: stability-window-artifacts
          path: |
            artifacts/tck/stability-daily-*.json
            artifacts/tck/stability-window.json
            artifacts/tck/stability-window.md
            artifacts/tck/stability-window-*.log
            artifacts/tck/stability-window-*.rc
