name: PR Check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  issues: read
  pull-requests: read

jobs:
  check-issue-link:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR description contains issue reference
        id: check-closes
        run: |
          set -euo pipefail

          # 直接从事件JSON中读取原始body，避免 shell 对反引号/美元符号做命令替换
          PR_BODY=$(node -e "const fs=require('fs');const path=process.env.GITHUB_EVENT_PATH;let body='';if(path&&fs.existsSync(path)){const data=JSON.parse(fs.readFileSync(path,'utf8'));body=data?.pull_request?.body||'';}process.stdout.write(body);")

          # 检查是否包含 Closes #数字 格式
          if printf '%s' "$PR_BODY" | grep -qE "Closes #[0-9]+"; then
            echo "✅ PR描述包含Issue关联"

            # 提取Issue编号
            ISSUE_NUMBER=$(printf '%s' "$PR_BODY" | grep -oE "Closes #[0-9]+" | head -1 | grep -oE "[0-9]+")
            echo "issue_number=$ISSUE_NUMBER" >> "$GITHUB_OUTPUT"
          else
            echo "❌ PR描述缺少Issue关联"
            echo "::error::PR描述必须包含 'Closes #<issue-number>' 格式的Issue关联"
            exit 1
          fi

      - name: Verify issue exists and is open
        if: steps.check-closes.outputs.issue_number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          ISSUE_NUMBER="${{ steps.check-closes.outputs.issue_number }}"

          # 检查Issue是否存在
          if ! gh issue view "$ISSUE_NUMBER" --repo ${{ github.repository }} > /dev/null 2>&1; then
            echo "❌ Issue #$ISSUE_NUMBER 不存在"
            echo "::error::Issue #$ISSUE_NUMBER 不存在，请检查Issue编号是否正确"
            exit 1
          fi

          # 检查Issue是否为open状态
          ISSUE_STATE=$(gh issue view "$ISSUE_NUMBER" --repo ${{ github.repository }} --json state --jq '.state')
          if [ "$ISSUE_STATE" != "OPEN" ]; then
            echo "❌ Issue #$ISSUE_NUMBER 已关闭"
            echo "::error::Issue #$ISSUE_NUMBER 已关闭，请使用open状态的Issue"
            exit 1
          fi

          echo "✅ Issue #$ISSUE_NUMBER 存在且为open状态"
