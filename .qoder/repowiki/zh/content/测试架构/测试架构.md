# 测试架构

<cite>
**本文档引用的文件**
- [vitest.config.ts](file://vitest.config.ts) - *已更新测试配置*
- [minHeap.ts](file://src/utils/minHeap.ts)
- [staging.ts](file://src/storage/staging.ts)
- [minHeap.test.ts](file://tests/unit/storage/minHeap.test.ts)
- [staging.test.ts](file://tests/unit/storage/staging.test.ts)
- [query.test.ts](file://tests/integration/query/aggregation.test.ts)
- [storage.test.ts](file://tests/integration/storage/wal.test.ts)
- [system.test.ts](file://tests/system/query_snapshot_isolation.test.ts)
- [performance.test.ts](file://tests/performance/performance_baseline.test.ts)
- [.github/workflows/ci.yml](file://.github/workflows/ci.yml) - *CI流程优化*
</cite>

## 更新摘要
**变更内容**
- 根据最新提交修复了因算法死循环导致测试挂起的问题
- 测试套件已拆分以提升可维护性，文档结构调整以反映新组织方式
- CI工作流优化，测试执行策略调整
- 更新Vitest配置说明，准确描述并发控制与资源管理机制

### 目录
1. [引言](#引言)
2. [测试分层策略](#测试分层策略)
3. [Vitest 框架配置与组织结构](#vitest-框架配置与组织结构)
4. [编写新的测试用例](#编写新的测试用例)
5. [测试驱动开发的重要性](#测试驱动开发的重要性)
6. [结论](#结论)

## 引言
SynapseDB 是一个高性能图数据库系统，其质量保障体系依赖于一套全面且分层的测试架构。该架构通过多种测试类型确保代码的正确性、稳定性与性能。本文档旨在揭示 SynapseDB 的测试体系，涵盖从单元测试到系统级验证的完整链条，并指导开发者如何遵循现有规范贡献高质量测试。

## 测试分层策略

SynapseDB 采用多层级测试策略，覆盖不同粒度和场景，确保软件质量在各个层面都得到保障。

### 单元测试：验证独立函数逻辑
单元测试聚焦于最小可测单元，如工具类 `MinHeap` 和暂存机制 `LsmLiteStaging`，验证其核心行为是否符合预期。

例如，`MinHeap` 类实现了最小堆数据结构，用于高效管理优先级队列。其单元测试验证了插入、弹出、查看最小值等操作的正确性以及堆序性质的维持。

```mermaid
flowchart TD
A[创建 MinHeap 实例] --> B[push(5), push(3), push(7)]
B --> C[peek() 应返回 3]
C --> D[pop() 应返回 3]
D --> E[size() 应为 2]
E --> F[连续 pop 应按升序返回: 3,5,7]
```

**Diagram sources**
- [minHeap.ts](file://src/utils/minHeap.ts#L4-L113)
- [minHeap.test.ts](file://tests/unit/storage/minHeap.test.ts#L1-L28)

类似地，`LsmLiteStaging` 类实现了一种轻量级 LSM 树内存暂存策略，支持记录添加、大小查询和批量清空（drain）。其单元测试覆盖了基础操作、泛型支持、边界条件及内部状态一致性。

```mermaid
flowchart TD
G[创建 LsmLiteStaging 实例] --> H[add('record-1'), add('record-2')]
H --> I[size() 应为 2]
I --> J[drain() 应返回 ['record-1','record-2']]
J --> K[size() 应为 0]
K --> L[再次 drain 应返回空数组]
```

**Diagram sources**
- [staging.ts](file://src/storage/staging.ts#L14-L29)
- [staging.test.ts](file://tests/unit/storage/staging.test.ts#L1-L270)

### 集成测试：覆盖模块间协作
集成测试关注多个模块协同工作时的行为，验证接口契约和数据流的正确性。例如，在查询与存储模块之间进行交互测试，确保 Cypher 查询能够正确访问由 WAL（Write-Ahead Log）持久化的数据。

这类测试通常涉及实际的磁盘 I/O、事务处理和索引更新，模拟真实使用场景下的组件交互。

**Section sources**
- [integration/query](file://tests/integration/query/)
- [integration/storage](file://tests/integration/storage/)

### 系统测试：检验端到端行为
系统测试从整体角度验证数据库的核心特性，包括事务隔离级别和故障恢复能力。

例如，`query_snapshot_isolation.test.ts` 验证快照隔离（Snapshot Isolation）语义是否正确实现，确保并发读写不会导致脏读或不可重复读。另一项关键测试是 `crash_injection.test.ts`，它通过注入崩溃来检验数据库能否在异常重启后保持数据一致性和持久性。

这些测试模拟生产环境中的极端情况，是保证数据库可靠性的最后一道防线。

**Section sources**
- [system/query_snapshot_isolation.test.ts](file://tests/system/query_snapshot_isolation.test.ts)
- [system/crash_injection.test.ts](file://tests/system/crash_injection.test.ts)

### 性能测试：监控关键路径开销
性能测试用于基线化和持续监控数据库的关键操作耗时，防止性能退化。

SynapseDB 包含多种性能测试用例，如 `performance_large_insert.test.ts` 评估大批量数据插入吞吐量，`property_index_performance.test.ts` 测量属性索引的查询延迟。这些测试帮助团队识别瓶颈并优化核心路径。

**Section sources**
- [performance/performance_baseline.test.ts](file://tests/performance/performance_baseline.test.ts)
- [performance/performance_large_insert.test.ts](file://tests/performance/performance_large_insert.test.ts)

## Vitest 框架配置与组织结构

SynapseDB 使用 [Vitest](https://vitest.dev/) 作为主要测试框架，因其速度快、TypeScript 支持良好且 API 与 Jest 兼容。

### vitest.config.ts 配置要点
主配置文件 `vitest.config.ts` 定义了测试运行环境的关键参数：

- **环境设置**：指定 `environment: 'node'`，适用于服务端数据库逻辑。
- **超时控制**：`testTimeout: 20000` 设置较长的超时时间，以适应涉及磁盘 I/O 的测试。
- **执行池策略**：使用 `pool: 'forks'` 并配置 `poolOptions.forks`，其中 `maxForks: 2` 限制并发进程数，降低内存压力；同时通过 `execArgv: ['--max-old-space-size=8192']` 增加每个进程的内存上限，应对 JIT 编译峰值。
- **串行执行**：`sequence.concurrent: false` 禁用并发测试执行，进一步减少资源竞争。
- **覆盖率配置**：设定语句、分支、函数和行数的覆盖率门槛分别为 80%、75%、80%、80%，并排除非核心逻辑文件（如 CLI、类型定义等）。

此配置确保测试稳定运行，尤其适合对 IO 和资源敏感的数据库系统。

**Section sources**
- [vitest.config.ts](file://vitest.config.ts#L1-L68)

### 测试组织方式
测试用例按功能目录划分，结构清晰，便于定位和维护：

```
tests/
├── unit/           # 单元测试
│   ├── utils/
│   ├── storage/
│   └── query/
├── integration/    # 集成测试
│   ├── query/
│   ├── storage/
│   └── maintenance/
├── system/         # 系统测试
├── performance/    # 性能测试
└── types/          # 类型测试
```

近期提交中已将大型测试套件拆分，提升了可维护性。CI 工作流也进行了优化，确保测试流程更加稳健。

**Section sources**
- [.github/workflows/ci.yml](file://.github/workflows/ci.yml#L1-L47)

## 编写新的测试用例

为 SynapseDB 贡献新测试应遵循以下模式：

### 模拟环境与构造测试数据
对于单元测试，通常无需外部依赖，直接实例化被测对象即可。对于涉及文件系统的测试，建议使用临时目录隔离副作用。

测试数据应覆盖典型用例和边界条件。例如，在测试 `LsmLiteStaging` 时，不仅测试字符串和数字，还测试 `null`、`undefined` 及复杂嵌套对象，确保泛型实现健壮。

### 断言期望结果
使用 `expect` 断言库验证输出是否符合预期。重要断言包括：
- 功能正确性（如 `pop()` 返回最小值）
- 状态一致性（如 `size()` 在 `drain()` 后归零）
- 性能约束（如大量数据 `drain()` 在 100ms 内完成）

示例片段（概念性）：
```ts
it('应该支持大量记录的添加', () => {
  const staging = new LsmLiteStaging<number>();
  for (let i = 0; i < 10000; i++) staging.add(i);
  expect(staging.size()).toBe(10000);
  const start = Date.now();
  const records = staging.drain();
  expect(records).toHaveLength(10000);
  expect(Date.now() - start).toBeLessThan(100);
});
```

**Section sources**
- [staging.test.ts](file://tests/unit/storage/staging.test.ts#L1-L270)

## 测试驱动开发的重要性

在数据库项目中，测试驱动开发（TDD）尤为重要。由于数据库涉及复杂的并发控制、持久化逻辑和状态转换，任何细微错误都可能导致数据损坏或服务中断。

通过先编写测试，开发者能更深入地思考接口设计和边界条件，从而构建出更可靠、可维护的代码。此外，丰富的测试套件为重构提供了安全保障，使团队能够持续改进架构而无后顾之忧。

SynapseDB 鼓励所有贡献者遵循现有测试规范，在提交新功能或修复缺陷时附带相应的测试用例，共同维护项目的高质量标准。

## 结论

SynapseDB 的测试架构是一个多层次、全方位的质量保障体系。从单元测试验证基础组件，到集成测试检查模块协作，再到系统测试验证核心语义与容错能力，最后通过性能测试监控运行效率，每一层都不可或缺。结合 Vitest 框架的合理配置与清晰的测试组织结构，该项目建立了一个可持续演进的测试生态。我们鼓励所有贡献者积极践行测试驱动开发，共同守护数据库的稳定性与可靠性。