# 图算法库使用指南

## 目标

- 使用 NervusDB 内置图算法（最短路径、中心性、社区、相似度）
- 将结果与 QueryBuilder/属性索引结合

## 初始化

```ts
import { GraphAlgorithms } from 'nervusdb/algorithms';
const graph = await GraphAlgorithms.open('graph.nervusdb');
```

## 最短路径（Dijkstra）

```ts
const path = await graph.shortestPath({
  source: 'user:alice',
  target: 'user:zoe',
  predicate: 'FRIEND_OF',
  weight: (edge) => (edge.edgeProperties?.weight as number) ?? 1,
});
```

## A\* 搜索

```ts
const coords = new Map<string, [number, number]>([
  ['user:alice', [121.5, 31.2]],
  ['user:zoe', [121.7, 31.3]],
]);

const path = await graph.aStar({
  source: 'user:alice',
  target: 'user:zoe',
  predicate: 'FRIEND_OF',
  heuristic: (node) => {
    const [lng, lat] = coords.get(node) ?? [0, 0];
    const [tlng, tlat] = coords.get('user:zoe') ?? [0, 0];
    return Math.hypot(lng - tlng, lat - tlat);
  },
});
```

## 社区发现（Louvain）

```ts
const communities = await graph.community({ predicate: 'FRIEND_OF' });
```

返回 `Map<社群ID, 节点列表>`，可用于推荐或社群分析。

## 中心性（PageRank）

```ts
const rank = await graph.pageRank({ predicate: 'FRIEND_OF', damping: 0.85, iterations: 20 });
```

## 相似度

```ts
const similarity = await graph.jaccard({
  predicate: 'FRIEND_OF',
  nodeA: 'user:alice',
  nodeB: 'user:bob',
});
```

## 与 QueryBuilder 联动

```ts
const topInfluencers = [...rank.entries()].sort((a, b) => b[1] - a[1]).slice(0, 10);

const details = await Promise.all(
  topInfluencers.map(([node]) => db.getNodeProperties(await db.getNodeId(node)!)),
);
```

## 常见问题

| 现象       | 原因                        | 解决                         |
| ---------- | --------------------------- | ---------------------------- |
| 运算时间长 | 节点/边数量巨大             | 限制谓词、分批处理、预先过滤 |
| 结果为空   | 图不连通或 predicate 不存在 | 检查数据、放宽参数           |
| 内存高     | 结果集大                    | 采用 Streaming 或分段计算    |

## 延伸阅读

- [docs/使用示例/路径与最短路径.md](路径与最短路径.md)
- [docs/教学文档/实战-代码知识图谱.md](../教学文档/实战-代码知识图谱.md)
