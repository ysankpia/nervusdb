# 插件系统使用指南

## 概述

NervusDB 采用插件架构来扩展功能，所有高级查询能力（路径查找、聚合、Cypher）均通过插件实现。插件系统的设计遵循"好品味"原则：用户无需关心插件加载细节，开箱即用。

## 默认插件

### 自动加载的插件

执行 `NervusDB.open()` 时，以下插件会自动加载：

1. **PathfindingPlugin**
   - 提供最短路径算法（BFS、双向BFS、Dijkstra、A\*）
   - API：`db.shortestPath()`、`db.shortestPathBidirectional()`、`db.shortestPathWeighted()`

2. **AggregationPlugin**
   - 提供聚合查询能力（COUNT、SUM、AVG、GROUP BY）
   - API：`db.aggregate()`

```ts
import { NervusDB } from 'nervusdb';

const db = await NervusDB.open('demo.nervusdb');

// 路径查找（PathfindingPlugin 已加载）
const path = db.shortestPath('user:alice', 'user:bob', {
  predicates: ['FRIEND_OF'],
  maxHops: 5,
});

// 聚合查询（AggregationPlugin 已加载）
const stats = await db
  .aggregate()
  .match({ predicate: 'WORKS_AT' })
  .groupBy(['object'])
  .count('memberCount')
  .execute();
```

## 实验性插件

### Cypher 查询语言插件

Cypher 插件默认**不加载**，需要显式启用：

```ts
const db = await NervusDB.open('demo.nervusdb', {
  experimental: {
    cypher: true,
  },
});

// Cypher 查询现在可用
const result = await db.cypher(`
  MATCH (p:Person)-[:FRIEND_OF*1..3]->(f)
  WHERE p.city = 'Shanghai'
  RETURN f LIMIT 10
`);
```

或者通过环境变量全局启用：

```bash
export SYNAPSEDB_ENABLE_EXPERIMENTAL_QUERIES=1
node your-app.js
```

## 插件管理 API

### 查询插件状态

```ts
// 检查插件是否可用
const hasCypher = db.hasPlugin('cypher');
console.log('Cypher 插件:', hasCypher ? '已加载' : '未加载');

// 列出所有已加载的插件
const plugins = db.listPlugins();
console.log('已加载插件:', plugins);
// 输出: [
//   { name: 'pathfinding', version: '1.0.0' },
//   { name: 'aggregation', version: '1.0.0' }
// ]

// 获取特定插件实例（高级用法）
const pathPlugin = db.plugin<PathfindingPlugin>('pathfinding');
if (pathPlugin) {
  // 直接调用插件方法
}
```

## 向后兼容说明

### 旧版 API 别名

为了保持向后兼容，以下别名仍然可用：

```ts
// 旧方式（仍然有效）
import { CoreNervusDB, ExtendedNervusDB } from 'nervusdb';

const db1 = await CoreNervusDB.open('demo.nervusdb');
const db2 = await ExtendedNervusDB.open('demo.nervusdb');

// 新方式（推荐）
import { NervusDB } from 'nervusdb';
const db = await NervusDB.open('demo.nervusdb');
```

**注意**：`CoreNervusDB` 和 `ExtendedNervusDB` 只是 `NervusDB` 的别名，没有功能差异。所有插件在打开数据库时已自动加载。

## 自定义插件开发（高级）

### 插件接口

```ts
import { NervusDBPlugin, PersistentStore, NervusDB } from 'nervusdb';

export class MyCustomPlugin implements NervusDBPlugin {
  name = 'my-custom';
  version = '1.0.0';

  private db!: NervusDB;
  private store!: PersistentStore;

  async initialize(db: NervusDB, store: PersistentStore): Promise<void> {
    this.db = db;
    this.store = store;
    // 初始化逻辑
  }

  async cleanup(): Promise<void> {
    // 清理逻辑
  }

  // 自定义方法
  async myCustomQuery(): Promise<void> {
    // 使用 this.store 访问存储层
  }
}
```

### 手动注册插件（不推荐）

虽然技术上可行，但**不推荐**手动管理插件：

```ts
import { NervusDB, PluginManager } from 'nervusdb';

const db = await NervusDB.open('demo.nervusdb');
const pluginManager = new PluginManager(db, db.getStore());

const myPlugin = new MyCustomPlugin();
pluginManager.register(myPlugin);
await pluginManager.initialize();
```

**为什么不推荐？**

- 违反"简洁至上"原则
- 容易引入加载顺序问题
- 未来版本可能不支持

**正确做法**：贡献到 `src/plugins/` 并在 `NervusDB.open()` 中默认加载。

## 插件能力对照表

| 插件              | 状态       | API 入口                          | 主要功能                    |
| ----------------- | ---------- | --------------------------------- | --------------------------- |
| PathfindingPlugin | 默认加载   | `db.shortestPath*()`              | BFS、双向BFS、Dijkstra、A\* |
| AggregationPlugin | 默认加载   | `db.aggregate()`                  | COUNT、SUM、AVG、GROUP BY   |
| CypherPlugin      | 实验性可选 | `db.cypher()` / `db.cypherRead()` | Cypher 查询语言解析与执行   |

## 常见问题

### Q1: 为什么 Cypher 需要手动启用？

**A**: Cypher 插件仍在实验阶段，语法支持不完整，启动开销较大。避免影响默认用户体验。

### Q2: 可以禁用默认插件吗？

**A**: 不可以。PathfindingPlugin 和 AggregationPlugin 是核心功能，禁用会导致 API 不可用。如果不使用这些功能，运行时开销接近零。

### Q3: 旧代码使用 `CoreNervusDB`，需要迁移吗？

**A**: 不需要。别名永久保持向后兼容。但新代码推荐使用 `NervusDB` 以保持简洁。

### Q4: 插件的初始化顺序重要吗？

**A**: 不重要。所有插件独立工作，不相互依赖。

## 相关文档

- [教程 02 · 数据模型与基础 CRUD](../教学文档/教程-02-数据模型与基础CRUD.md)
- [附录 · API 参考](../教学文档/附录-API参考.md)
- [Cypher 语法参考](./Cypher语法参考.md)
- [图算法库使用指南](./图算法库使用指南.md)
