# 示例 05 · 维护与治理

## 目标

- 建立日常巡检、压实、GC、修复的脚本化流程
- 演示如何将 CLI 输出写入日志并分析

## 核心脚本

```bash
#!/usr/bin/env bash
set -euo pipefail
DB=$1
LOG_DIR=/var/log/nervusdb
mkdir -p "$LOG_DIR"

nervusdb stats "$DB" --summary --json > "$LOG_DIR/$(date +%F)-stats.json"
nervusdb auto-compact "$DB" --mode=incremental --hot-threshold=1.1 --max-primary=5 --auto-gc
nervusdb txids "$DB" --since=60 --json > "$LOG_DIR/$(date +%F)-txids.json"
```

## 关键命令

```bash
nervusdb check demo.nervusdb --strict
nervusdb repair demo.nervusdb --fast
nervusdb hot demo.nervusdb --top=10
nervusdb gc demo.nervusdb --respect-readers
```

## 日志解析

```bash
jq '.orders.SPO.multiPagePrimaries' logs/2025-09-28-stats.json
```

## 自动化建议

- 使用 `cron` 每小时执行 auto-compact
- 使用 `systemd` timer 保证重启后仍能运行
- 将 JSON 日志推送到 ELK / Loki 统一分析

## 延伸阅读

- [教程 06 · 维护与治理](../教学文档/教程-06-维护与治理.md)
- [示例 09 · 嵌入式脚本与自动化](09-嵌入式脚本与自动化-示例.md)
