# SynapseDB æ€§èƒ½åŸºå‡†æµ‹è¯•æŒ‡å—

SynapseDB v1.1 æä¾›äº†å®Œæ•´çš„æ€§èƒ½åŸºå‡†æµ‹è¯•æ¡†æ¶ï¼Œç”¨äºè¯„ä¼°æ•°æ®åº“åœ¨å„ç§å·¥ä½œè´Ÿè½½ä¸‹çš„è¡¨ç°ã€‚

## å¿«é€Ÿæµ‹è¯•

### è¿è¡Œå†…ç½®åŸºå‡†æµ‹è¯•

```bash
# å¿«é€ŸåŸºå‡†æµ‹è¯•ï¼ˆé€‚ç”¨äº CI/å¼€å‘ç¯å¢ƒï¼‰
node benchmarks/quick.mjs

# å…¨é¢åŸºå‡†æµ‹è¯•ï¼ˆé€‚ç”¨äºæ€§èƒ½è¯„ä¼°ï¼‰
node benchmarks/comprehensive.mjs

# è‡ªå®šä¹‰é…ç½®è¿è¡Œ
SCALE_FACTOR=0.5 ITERATIONS=100 node benchmarks/comprehensive.mjs
```

### ç¯å¢ƒå˜é‡é…ç½®

```bash
# ç¼©æ”¾å› å­ï¼ˆæ•°æ®é‡å€æ•°ï¼Œé»˜è®¤ 1.0ï¼‰
SCALE_FACTOR=2.0

# è¿­ä»£æ¬¡æ•°ï¼ˆé»˜è®¤ 3ï¼‰
ITERATIONS=5

# è¯¦ç»†è¾“å‡ºï¼ˆé»˜è®¤ falseï¼‰
VERBOSE=true

# ç»“æœè¾“å‡ºç›®å½•ï¼ˆé»˜è®¤ ./benchmark-resultsï¼‰
OUTPUT_DIR=./performance-reports
```

## åŸºå‡†æµ‹è¯•ç±»å‹

### 1. å†™å…¥æ€§èƒ½æµ‹è¯•

```javascript
import { createBenchmarkFramework } from './benchmarks/framework.mjs';

const framework = createBenchmarkFramework('./benchmark.synapsedb');

// æ‰¹é‡å†™å…¥æµ‹è¯•
const writeResults = await framework.runSuite('å†™å…¥æ€§èƒ½æµ‹è¯•', [
  {
    name: 'å•æ¡ Fact æ’å…¥',
    setup: async (db) => { /* å‡†å¤‡æ•°æ® */ },
    run: async (db) => {
      for (let i = 0; i < 1000; i++) {
        db.addFact({
          subject: `node_${i}`,
          predicate: 'connects_to',
          object: `node_${i + 1}`
        });
      }
    },
    teardown: async (db) => { await db.flush(); }
  },
  {
    name: 'æ‰¹é‡äº‹åŠ¡å†™å…¥',
    setup: async (db) => { /* å‡†å¤‡æ•°æ® */ },
    run: async (db) => {
      db.beginBatch();
      for (let i = 0; i < 1000; i++) {
        db.addFact({
          subject: `batch_${i}`,
          predicate: 'relates_to',
          object: `batch_${i + 1}`
        });
      }
      await db.commitBatch();
    }
  }
]);

console.log('å†™å…¥æ€§èƒ½ç»“æœ:', writeResults);
```

### 2. æŸ¥è¯¢æ€§èƒ½æµ‹è¯•

```javascript
// æŸ¥è¯¢æ€§èƒ½åŸºå‡†
const queryResults = await framework.runSuite('æŸ¥è¯¢æ€§èƒ½æµ‹è¯•', [
  {
    name: 'ç®€å•æ¡ä»¶æŸ¥è¯¢',
    setup: async (db) => {
      // å‡†å¤‡æµ‹è¯•æ•°æ®
      for (let i = 0; i < 10000; i++) {
        db.addFact({
          subject: `user_${i}`,
          predicate: 'likes',
          object: `item_${i % 100}`
        });
      }
      await db.flush();
    },
    run: async (db) => {
      // æµ‹è¯•å„ç§æŸ¥è¯¢æ¨¡å¼
      const results1 = db.find({ predicate: 'likes' }).limit(100).all();
      const results2 = db.find({ object: 'item_50' }).all();
      const results3 = db.find({ subject: 'user_500' }).all();

      return results1.length + results2.length + results3.length;
    }
  },
  {
    name: 'é“¾å¼è”æƒ³æŸ¥è¯¢',
    run: async (db) => {
      const results = db
        .find({ subject: 'user_100' })
        .follow('likes')
        .followReverse('likes')
        .limit(50)
        .all();

      return results.length;
    }
  }
]);
```

### 3. å†…å­˜ä½¿ç”¨æµ‹è¯•

```javascript
// å†…å­˜ä½¿ç”¨åŸºå‡†
const memoryResults = await framework.runSuite('å†…å­˜ä½¿ç”¨æµ‹è¯•', [
  {
    name: 'å¤§æ•°æ®é›†åŠ è½½',
    beforeMemory: true,
    afterMemory: true,
    run: async (db) => {
      // åŠ è½½å¤§é‡æ•°æ®
      for (let i = 0; i < 50000; i++) {
        db.addFact({
          subject: `large_${i}`,
          predicate: 'contains',
          object: `data_${i}`,
        }, {
          subjectProperties: {
            type: 'dataset',
            size: i,
            metadata: new Array(100).fill(i).join(',')
          }
        });
      }
      await db.flush();
    }
  }
]);
```

### 4. å¹¶å‘æ€§èƒ½æµ‹è¯•

```javascript
// å¹¶å‘è¯»å†™æµ‹è¯•
const concurrentResults = await framework.runSuite('å¹¶å‘æ€§èƒ½æµ‹è¯•', [
  {
    name: 'å¤šçº¿ç¨‹è¯»å–æµ‹è¯•',
    run: async (db) => {
      const promises = Array.from({ length: 10 }, (_, threadId) =>
        Promise.resolve().then(async () => {
          const results = [];
          for (let i = 0; i < 100; i++) {
            const query = db.find({
              predicate: 'test_predicate',
              subject: `thread_${threadId}_${i}`
            });
            results.push(...query.all());
          }
          return results.length;
        })
      );

      const allResults = await Promise.all(promises);
      return allResults.reduce((sum, count) => sum + count, 0);
    }
  }
]);
```

## è‡ªå®šä¹‰åŸºå‡†æµ‹è¯•

### åˆ›å»ºæµ‹è¯•å¥—ä»¶

```javascript
// custom-benchmark.mjs
import { createBenchmarkFramework } from './benchmarks/framework.mjs';
import { SynapseDB } from '../dist/index.js';

async function customBenchmark() {
  const framework = createBenchmarkFramework('./custom-test.synapsedb');

  const results = await framework.runSuite('è‡ªå®šä¹‰æµ‹è¯•å¥—ä»¶', [
    {
      name: 'ç‰¹å®šåœºæ™¯æµ‹è¯•',
      validate: (result) => result > 0, // ç»“æœéªŒè¯
      iterations: 5,                     // é‡å¤æ¬¡æ•°
      timeout: 30000,                    // è¶…æ—¶æ—¶é—´(ms)
      setup: async (db) => {
        // æµ‹è¯•å‡†å¤‡
        console.log('å‡†å¤‡æµ‹è¯•æ•°æ®...');
      },
      run: async (db) => {
        // æ ¸å¿ƒæµ‹è¯•é€»è¾‘
        const startTime = performance.now();

        // ä½ çš„æµ‹è¯•ä»£ç 
        for (let i = 0; i < 1000; i++) {
          db.addFact({
            subject: `custom_${i}`,
            predicate: 'custom_relation',
            object: `target_${i % 10}`
          });
        }

        const endTime = performance.now();
        return { duration: endTime - startTime, operations: 1000 };
      },
      teardown: async (db) => {
        // æ¸…ç†å·¥ä½œ
        await db.flush();
      }
    }
  ]);

  // è¾“å‡ºç»“æœ
  framework.printResults(results);

  // å¯¼å‡ºæŠ¥å‘Š
  await framework.exportResults('./custom-benchmark-report.json', results);

  await framework.cleanup();
}

customBenchmark().catch(console.error);
```

## æ€§èƒ½åˆ†æ

### 1. å»¶è¿Ÿåˆ†æ

```javascript
const latencyTest = {
  name: 'å»¶è¿Ÿåˆ†æ',
  run: async (db) => {
    const latencies = [];

    for (let i = 0; i < 1000; i++) {
      const start = performance.now();

      db.addFact({
        subject: `latency_${i}`,
        predicate: 'measures',
        object: 'performance'
      });

      const end = performance.now();
      latencies.push(end - start);
    }

    // è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    latencies.sort((a, b) => a - b);
    const p50 = latencies[Math.floor(latencies.length * 0.5)];
    const p95 = latencies[Math.floor(latencies.length * 0.95)];
    const p99 = latencies[Math.floor(latencies.length * 0.99)];
    const avg = latencies.reduce((sum, lat) => sum + lat, 0) / latencies.length;

    return { p50, p95, p99, avg, min: latencies[0], max: latencies[latencies.length - 1] };
  }
};
```

### 2. ååé‡åˆ†æ

```javascript
const throughputTest = {
  name: 'ååé‡åˆ†æ',
  run: async (db) => {
    const duration = 10000; // 10ç§’æµ‹è¯•
    const startTime = Date.now();
    let operations = 0;

    // è¿ç»­æ‰§è¡Œæ“ä½œç›´åˆ°æ—¶é—´åˆ°
    while (Date.now() - startTime < duration) {
      db.addFact({
        subject: `throughput_${operations}`,
        predicate: 'tests',
        object: 'throughput'
      });
      operations++;
    }

    const actualDuration = Date.now() - startTime;
    const opsPerSecond = (operations * 1000) / actualDuration;

    return { operations, duration: actualDuration, opsPerSecond };
  }
};
```

### 3. èµ„æºä½¿ç”¨åˆ†æ

```javascript
const resourceTest = {
  name: 'èµ„æºä½¿ç”¨åˆ†æ',
  beforeMemory: true,
  afterMemory: true,
  beforeDisk: true,
  afterDisk: true,
  run: async (db) => {
    // æ‰§è¡Œèµ„æºå¯†é›†æ“ä½œ
    const batchSize = 10000;

    db.beginBatch();
    for (let i = 0; i < batchSize; i++) {
      db.addFact({
        subject: `resource_${i}`,
        predicate: 'consumes',
        object: 'memory'
      }, {
        subjectProperties: {
          data: new Array(1000).fill('x').join(''),
          timestamp: Date.now(),
          index: i
        }
      });
    }
    await db.commitBatch();

    // å¼ºåˆ¶æŒä¹…åŒ–
    await db.flush();

    return batchSize;
  }
};
```

## åŸºå‡†æµ‹è¯•æœ€ä½³å®è·µ

### 1. æ•°æ®å‡†å¤‡

```javascript
// ç¡®ä¿æµ‹è¯•æ•°æ®çš„ä¸€è‡´æ€§
async function prepareTestData(db, scale = 1.0) {
  const baseSize = Math.floor(10000 * scale);

  console.log(`å‡†å¤‡ ${baseSize} æ¡æµ‹è¯•æ•°æ®...`);

  // ä½¿ç”¨å›ºå®šç§å­ç¡®ä¿å¯é‡å¤æ€§
  const seed = 12345;
  let random = seed;
  const nextRandom = () => {
    random = (random * 1103515245 + 12345) % (2**31);
    return random / (2**31);
  };

  db.beginBatch();
  for (let i = 0; i < baseSize; i++) {
    const subjectId = Math.floor(nextRandom() * (baseSize / 10));
    const objectId = Math.floor(nextRandom() * (baseSize / 10));

    db.addFact({
      subject: `node_${subjectId}`,
      predicate: 'relates_to',
      object: `node_${objectId}`
    }, {
      subjectProperties: { type: 'test_node', value: subjectId },
      objectProperties: { type: 'test_node', value: objectId },
      edgeProperties: { weight: nextRandom(), created: Date.now() - i * 1000 }
    });
  }
  await db.commitBatch();

  console.log('æµ‹è¯•æ•°æ®å‡†å¤‡å®Œæˆ');
}
```

### 2. æµ‹è¯•éš”ç¦»

```javascript
// æ¯ä¸ªæµ‹è¯•ä½¿ç”¨ç‹¬ç«‹çš„æ•°æ®åº“å®ä¾‹
async function isolatedTest(testName, testFn) {
  const dbPath = `./test-${testName}-${Date.now()}.synapsedb`;
  const db = await SynapseDB.open(dbPath);

  try {
    return await testFn(db);
  } finally {
    await db.close();
    // æ¸…ç†æµ‹è¯•æ–‡ä»¶
    await fs.unlink(dbPath).catch(() => {});
  }
}
```

### 3. ç»“æœéªŒè¯

```javascript
const validatedTest = {
  name: 'ç»“æœéªŒè¯æµ‹è¯•',
  validate: (result) => {
    // éªŒè¯ç»“æœçš„æ­£ç¡®æ€§
    if (typeof result !== 'object') return false;
    if (result.inserted < 1000) return false;
    if (result.queried < 100) return false;
    return true;
  },
  run: async (db) => {
    // æ’å…¥æ•°æ®
    const inserted = 1000;
    for (let i = 0; i < inserted; i++) {
      db.addFact({
        subject: `validate_${i}`,
        predicate: 'validates',
        object: 'correctness'
      });
    }

    // æŸ¥è¯¢éªŒè¯
    const results = db.find({ predicate: 'validates' }).all();
    const queried = results.length;

    return { inserted, queried };
  }
};
```

## æ€§èƒ½ç›‘æ§

### 1. æŒç»­ç›‘æ§

```javascript
// monitoring.mjs
import { createBenchmarkFramework } from './benchmarks/framework.mjs';

async function continuousMonitoring() {
  const framework = createBenchmarkFramework('./monitor.synapsedb');

  // å®šä¹‰å…³é”®æ€§èƒ½æŒ‡æ ‡æµ‹è¯•
  const kpiTests = [
    {
      name: 'KPI_å†™å…¥å»¶è¿Ÿ',
      target: { p95: 5 }, // ç›®æ ‡: P95 < 5ms
      run: async (db) => {
        const latencies = [];
        for (let i = 0; i < 100; i++) {
          const start = performance.now();
          db.addFact({
            subject: `kpi_${i}`,
            predicate: 'monitors',
            object: 'performance'
          });
          latencies.push(performance.now() - start);
        }

        latencies.sort((a, b) => a - b);
        return { p95: latencies[Math.floor(latencies.length * 0.95)] };
      }
    }
  ];

  // è¿è¡Œç›‘æ§
  const results = await framework.runSuite('KPIç›‘æ§', kpiTests);

  // æ£€æŸ¥æ˜¯å¦è¾¾æ ‡
  for (const result of results) {
    if (result.target && result.result.p95 > result.target.p95) {
      console.error(`ğŸš¨ æ€§èƒ½å‘Šè­¦: ${result.name} P95å»¶è¿Ÿ ${result.result.p95}ms è¶…è¿‡ç›®æ ‡ ${result.target.p95}ms`);
    } else {
      console.log(`âœ… ${result.name} è¾¾æ ‡: P95å»¶è¿Ÿ ${result.result.p95}ms`);
    }
  }

  await framework.cleanup();
}

// å®šæ—¶æ‰§è¡Œ
setInterval(continuousMonitoring, 60000); // æ¯åˆ†é’Ÿæ£€æŸ¥
```

### 2. æ€§èƒ½å›å½’æµ‹è¯•

```javascript
// regression-test.mjs
async function regressionTest() {
  // åŠ è½½åŸºå‡†ç»“æœ
  const baseline = await loadBaselineResults('./baseline-results.json');

  // è¿è¡Œå½“å‰æµ‹è¯•
  const framework = createBenchmarkFramework('./regression.synapsedb');
  const current = await framework.runSuite('å›å½’æµ‹è¯•', baseline.tests);

  // æ¯”è¾ƒç»“æœ
  const comparison = compareResults(baseline.results, current);

  for (const test of comparison) {
    const change = ((test.current - test.baseline) / test.baseline) * 100;

    if (Math.abs(change) > 10) { // å˜åŒ–è¶…è¿‡10%
      console.log(`ğŸ“ˆ æ€§èƒ½å˜åŒ–: ${test.name} ${change > 0 ? '+' : ''}${change.toFixed(1)}%`);

      if (change > 20) { // æ€§èƒ½ä¸¥é‡é€€åŒ–
        console.error(`ğŸš¨ æ€§èƒ½ä¸¥é‡é€€åŒ–: ${test.name}`);
        process.exit(1);
      }
    }
  }

  await framework.cleanup();
}
```

## æŠ¥å‘Šç”Ÿæˆ

### 1. HTML æŠ¥å‘Š

```javascript
async function generateHTMLReport(results) {
  const html = `
<!DOCTYPE html>
<html>
<head>
  <title>SynapseDB æ€§èƒ½æŠ¥å‘Š</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>æ€§èƒ½åŸºå‡†æµ‹è¯•æŠ¥å‘Š</h1>
  <div id="results">
    ${results.map(result => `
      <div class="test-result">
        <h3>${result.name}</h3>
        <p>å¹³å‡æ‰§è¡Œæ—¶é—´: ${result.avgDuration}ms</p>
        <p>æ“ä½œæ•°: ${result.operations || 'N/A'}</p>
        <canvas id="${result.name.replace(/\s+/g, '-')}-chart"></canvas>
      </div>
    `).join('')}
  </div>
</body>
</html>`;

  await fs.writeFile('./performance-report.html', html);
}
```

### 2. JSON å¯¼å‡º

```javascript
async function exportDetailedResults(results, filename) {
  const report = {
    timestamp: new Date().toISOString(),
    environment: {
      node: process.version,
      platform: process.platform,
      arch: process.arch,
      memory: process.memoryUsage()
    },
    results: results.map(result => ({
      name: result.name,
      metrics: result.metrics,
      duration: result.duration,
      iterations: result.iterations,
      memoryUsage: result.memoryUsage,
      success: result.success,
      error: result.error || null
    }))
  };

  await fs.writeFile(filename, JSON.stringify(report, null, 2));
}
```

é€šè¿‡è¿™ä¸ªåŸºå‡†æµ‹è¯•æ¡†æ¶ï¼Œä½ å¯ä»¥å…¨é¢è¯„ä¼° SynapseDB åœ¨ä¸åŒåœºæ™¯ä¸‹çš„æ€§èƒ½è¡¨ç°ï¼Œç¡®ä¿æ•°æ®åº“åœ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„å¯é æ€§å’Œé«˜æ•ˆæ€§ã€‚