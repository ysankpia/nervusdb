# 示例 06 · 流式查询与大结果

## 目标

- 处理百万级别事实的查询结果
- 展示 Streaming、批处理与 backpressure 控制

## 数据准备

```bash
synapsedb bench large.synapsedb 10000 lsm
```

## Streaming 示例（推荐惰性链）

```ts
// 灰度：使用惰性链按批次消费（不占大内存）
const iterator = db.findLazy({ predicate: 'FRIEND_OF' }).batch(500);
for await (const batch of iterator) {
  // 在这里处理批次，例如写入文件或推送到队列
  console.log('batch length', batch.length);
}
```

## 链式 Streaming（避免内存过滤）

```ts
for await (const edges of db.findLazy({ predicate: 'FRIEND_OF' })
  .whereProperty('strength', '>=', 0.6, 'edge')
  .batch(256)) {
  // 业务处理
}
```

## 控制 backpressure

- 减小 `batchSize`
- 将处理逻辑改为异步队列
- 使用 `setImmediate` 或消息队列分发

## 导出为 NDJSON

```ts
import { createWriteStream } from 'node:fs';
const out = createWriteStream('friends.ndjson');

for await (const batch of db.findLazy({ predicate: 'FRIEND_OF' }).batch(256)) {
  for (const fact of batch) {
    out.write(`${JSON.stringify(fact)}\n`);
  }
}
out.end();
```

## 常见问题

| 现象     | 原因               | 解决                           |
| -------- | ------------------ | ------------------------------ |
| 内存上涨 | 批次过大或同步处理 | 减小 batchSize、异步落盘       |
| 速度慢   | I/O 瓶颈           | 使用并行写入、拆分多个 stream  |
| 查询中断 | 后台治理打断       | 在命令执行前完成治理或使用快照 |

> 警告：避免使用 `where(predicate)` 在内存中过滤大结果集。请改用 `whereProperty`/`whereLabel` 或在 `follow` 阶段下推过滤条件。

### 环境变量

- `SYNAPSEDB_LAZY_QUERY=1`：让 `find()` 也返回惰性链（默认关闭）
- `SYNAPSEDB_QUERY_WARN_THRESHOLD`：大结果内存操作的告警阈值（默认 5000；0 关闭阈值）
- `SYNAPSEDB_SILENCE_QUERY_WARNINGS=1`：关闭告警

## 延伸阅读

- [教程 03 · 查询与链式联想](../教学文档/教程-03-查询与链式联想.md)
- [docs/使用示例/流式查询使用教程.md](流式查询使用教程.md)
