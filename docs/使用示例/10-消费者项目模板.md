# 示例 10 · 消费者项目模板

## 目标

- 为上游系统提供标准化的 NervusDB 接入模板
- 统一依赖、配置、脚本与 CI 流程

## 目录结构

```
consumer-app/
  src/
    index.ts
    routes/
      graph.ts
  synapse/
    data/                 # 数据库存放目录
    scripts/
      import.ts
      compact.ts
  package.json
  tsconfig.json
  pnpm-workspace.yaml
```

## package.json 关键字段

```json
{
  "type": "module",
  "scripts": {
    "dev": "tsx watch src/index.ts",
    "start": "node dist/index.js",
    "synapse:import": "tsx synapse/scripts/import.ts",
    "synapse:compact": "nervusdb auto-compact synapse/data/app.nervusdb --auto-gc"
  },
  "dependencies": {
    "nervusdb": "^1.1.0"
  }
}
```

## 导入脚本示例

```ts
// synapse/scripts/import.ts
import { NervusDB } from 'nervusdb';
import data from '../data/bootstrap.json' assert { type: 'json' };

const db = await NervusDB.open('synapse/data/app.nervusdb', {
  enableLock: true,
  enablePersistentTxDedupe: true,
});

db.beginBatch({ txId: `bootstrap-${Date.now()}`, sessionId: 'bootstrap' });
for (const fact of data.facts) {
  await db.addFact(fact.entity, fact.props);
}
db.commitBatch();
await db.flush();
await db.close();
```

## API 服务集成

```ts
// src/routes/graph.ts
import { Router } from 'express';
import { NervusDB } from 'nervusdb';

const router = Router();
const dbPromise = NervusDB.open('synapse/data/app.nervusdb');

router.get('/graph/connections', async (req, res) => {
  const db = await dbPromise;
  const { user } = req.query;
  const chain = await db
    .find({ subject: `user:${user}`, predicate: 'FRIEND_OF' })
    .follow('FRIEND_OF')
    .limit(10)
    .all();
  res.json(chain);
});

export default router;
```

## CI 验证

```yaml
- run: pnpm synapse:import
- run: nervusdb stats synapse/data/app.nervusdb --summary
- run: pnpm test
```

## 延伸阅读

- [教程 01 · 安装与环境](../教学文档/教程-01-安装与环境.md)
- [实战 · 商城系统](../教学文档/实战-商城系统.md)
