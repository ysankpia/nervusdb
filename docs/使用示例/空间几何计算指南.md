# 空间几何计算指南

## 目标

- 使用空间索引存储点/线/面几何数据
- 执行范围、相交、最近邻查询

## 初始化

```ts
import { SpatialStore } from 'nervusdb/spatial';

const spatial = await SpatialStore.open('geo.nervusdb');
```

## 插入几何

```ts
await spatial.insertGeometry('cluster:001', {
  type: 'Point',
  coordinates: [121.5, 31.2],
});

await spatial.insertGeometry('zone:001', {
  type: 'Polygon',
  coordinates: [
    [
      [121.4, 31.1],
      [121.6, 31.1],
      [121.6, 31.3],
      [121.4, 31.3],
      [121.4, 31.1],
    ],
  ],
});
```

## 查询

```ts
const within = await spatial.searchWithin({
  type: 'Polygon',
  coordinates: [
    [
      [121.45, 31.15],
      [121.55, 31.15],
      [121.55, 31.25],
      [121.45, 31.25],
      [121.45, 31.15],
    ],
  ],
});

const nearest = await spatial.searchNearest({
  type: 'Point',
  coordinates: [121.48, 31.22],
  limit: 5,
});
```

## 更新与删除

```ts
await spatial.updateGeometry('cluster:001', { type: 'Point', coordinates: [121.55, 31.25] });
await spatial.removeGeometry('zone:001');
```

## 与三元组关联

```ts
await db.addFact(
  { subject: 'warehouse:shanghai', predicate: 'LOCATED_AT', object: 'cluster:001' },
  { edgeProperties: { area: '华东' } },
);
```

## 常见问题

| 情况         | 原因             | 解决                              |
| ------------ | ---------------- | --------------------------------- |
| 查询结果为空 | 坐标系不一致     | 使用统一经纬度或转换工具          |
| 插入失败     | GeoJSON 格式错误 | 检查 `type` 与 `coordinates` 结构 |
| 性能慢       | 对象数量巨大     | 调整批量写入、分层索引            |

## 延伸阅读

- [docs/教学文档/教程-05-索引选择与性能.md](../教学文档/教程-05-索引选择与性能.md)
- [docs/使用示例/08-图谱导出与可视化-示例.md](08-图谱导出与可视化-示例.md)
