# 示例 04 · 事务与幂等

## 目标

- 展示批次写入、事务 ID 幂等、崩溃恢复流程
- 结合 CLI 检查 `txids.json`

## 步骤

### 1. 写入批次

```ts
const db = await NervusDB.open('orders.nervusdb', {
  enableLock: true,
  enablePersistentTxDedupe: true,
});

db.beginBatch({ txId: 'order-1001', sessionId: 'order-service' });
await db.addFact({ subject: 'order:1001', predicate: 'PLACED_BY', object: 'user:alice' });
await db.addFact({ subject: 'order:1001', predicate: 'CONTAINS', object: 'sku:keyboard' });
db.commitBatch({ durable: true });
await db.flush();
await db.close();
```

### 2. 重复提交（模拟重试）

再次执行上述代码。输出日志显示 `Skipped duplicate txId=order-1001`

### 3. 查看事务注册表

```bash
nervusdb txids orders.nervusdb --list=10
```

### 4. 崩溃恢复演练

1. 在 `commitBatch` 前故意抛错并 `abortBatch`，观察 WAL 中只有 BEGIN/ABORT
2. 手动复制数据库文件，删除 `orders.nervusdb.wal`
3. 恢复后执行 `nervusdb stats`，数据完整

### 5. 清空事务注册表（谨慎）

```bash
nervusdb txids orders.nervusdb --clear
```

> 清空后同一 `txId` 可能再次生效，请确保业务可接受。

## 常见问题

| 情况         | 解决                                                      |
| ------------ | --------------------------------------------------------- |
| 批次未提交   | 确认 `commitBatch` 在 `try` 块中调用，出错后 `abortBatch` |
| 事务 ID 冲突 | 使用不同 `sessionId` 区分来源、避免业务级重复             |
| WAL 文件大   | 定期 `db.flush()` 结合 `auto-compact`                     |

## 延伸阅读

- [教程 04 · 事务、WAL 与幂等](../教学文档/教程-04-事务-WAL-幂等.md)
- [示例 07 · 快照一致性与并发](07-快照一致性与并发-示例.md)
