NervusDB 项目审查报告（codex / ultrathink）

本文基于仓库内 repomix 打包结果与源码/测试实证，给出对当前实现进度、真实完成度与不足之处的审查结论，并提供可执行的改进路线图。时间与命名对齐同批报告：0918-16:47。

—

一、结论（先给答案）

- 整体完成度：高（≈85%~92% 区间）。核心能力已贯通：单文件主数据 + 六序分页索引、WAL v2 批次/重放、链式联想查询、读快照一致性（epoch-pin）、自动/增量合并与 GC、读者/热度治理与 CLI 运维。
- 工程成熟度：已具备 Alpha→Beta 的关键要素；按测试覆盖与实现深度判断，可进入“小规模对内试用 + 运维流程演练”。
- 主要风险/短板：主文件 flush 仍是 O(N) 写放大；manifest 写入在大页数下存在 JSON 序列化与 I/O 体量压力；快照期强依赖内存视图导致大数据集内存压力；读者注册在极端并发读者数下需要观测优化。

—

二、证据节选（代码与测试锚点）

- 崩溃安全落盘序列：临时文件 → fsync → rename → fsync 目录
  - src/storage/persistentStore.ts:4619,4629-4633,4640
  - src/storage/pagedIndex.ts:5023-5033（manifest 原子写）
- 分页索引与清单（页/epoch/tombstones/orphans，支持 brotli）
  - src/storage/pagedIndex.ts:4993-5005,5037-5041,9662-9667
  - tests/manifest_atomic_update.test.ts:1308,1331-1349,1456-1491
- WAL v2 批次与重放（BEGIN/COMMIT/ABORT，durable commit）
  - src/storage/wal.ts:6905-7001,7045-7209
  - tests/wal\_\*.test.ts 多组覆盖：abort/durable/txId 幂等/尾部截断
- 链式联想与读快照一致性（withSnapshot + epoch pin）
  - src/synapseDb.ts:7630-7654；tests/query_snapshot_isolation.test.ts:1526,1569,1603
  - 查询链 follow/followReverse：src/query/queryBuilder.ts:4255; tests/queryBuilder.test.ts:9150-9178
- 读者与热度治理（尊重读者、热点统计）
  - src/storage/readerRegistry.ts:6326-6332；src/storage/hotness.ts:4701-4724
  - tests/auto_compact_respect_readers.test.ts, gc_respect_readers.test.ts

—

三、真实进度评估

- 存储与持久化
  - 主文件 + 分页索引目录 + WAL v2 已稳定打通，manifest 原子更新与 epoch 推进机制健全。
  - LSM-lite 段旁路与清单（lsm-manifest.json）具备实验性流程，用于批量写入阶段的临时缓冲与并入。
- 查询与一致性
  - find/follow/followReverse/where/limit/anchor 可用；withSnapshot 将查询链固定在同一 epoch，避免 compaction/GC 干扰。
- 运维与工具链
  - 提供 db:check/repair/compact/auto-compact/gc/hot/stats/txids/dump 等脚本，已能覆盖开发/演练环境的主要治理动作。
- 测试面
  - 现有 37 个测试文件覆盖 WAL、快照一致性、索引选择、增量/整序合并、GC、修复、锁/读者等核心路径，具备较强的回归保护力。

—

四、主要不足与风险（按优先级）

P0（上线前需收敛）

- Flush 写放大：PersistentStore.flush 仍会对主数据执行全量序列化与重写，规模上升时 I/O 成本线性增长（大 N 下抖动明显）。建议将“权威数据源”下沉到分页索引，主文件尽量保持稳定头/元数据；将 flush 语义转为“将 WAL 增量安全地并入页索引 + 清单 bump”。
- Manifest 体量与序列化：大页数下 JSON 字符串化与落盘体积过大，写入时间长。建议继续保持紧凑 JSON（已采用），并引入“页映射旁表/块索引”将大数组拆分，manifest 仅保存概要与偏移，降低写放大。

P1（重要增强）

- 快照期间内存压力：withSnapshot 期间优先使用内存视图，面对大库存在显著内存占用。建议在快照期引入“只读页游标 + 页级校验重试”的折中策略，允许在不牺牲一致性的情况下更多依赖磁盘页。
- 读者注册扩展性：极端高并发读者数时 getActiveReaders 需要遍历大量文件，建议追加“稀疏刷新 + 缓存 + 轻量索引文件”策略，并提供 db:readers 观测入口。
- 观测性与指标：为 auto-compact/GC/repair 增加更细的统计输出与慢操作日志，配合 hotness 形成可解释的治理决策闭环。

P2（中期路线）

- 更强查询优化：多谓词联结、统计信息驱动的索引选择、属性倒排的下推执行。
- 内存/IO 优化：大页 mmap/分片读写评估，或以 Rust/WASM 模块引入热点路径加速。

—

五、可执行改进路线图（建议）

里程碑 A（稳定与可伸缩性）

1. 增量 flush 改造：以分页索引为权威，flush 仅并入 WAL 增量并 bump manifest（保留 tombstones/hotness 现有流程）。
2. Manifest 轻量化：旁表化页映射（页目录/稀疏表），manifest 仅存版本、统计与偏移指针；配套读写器与兼容迁移。
3. 快照期页游标：实现“快照读页游标 + 内存最小化”策略，在快照内允许页重读但保证校验一致与结果稳定。

里程碑 B（观测与治理）4) CLI 观测补强：db:readers、db:hot --topN、db:stats 增强维度与耗时打印；auto-compact 输出决策因子与分数。5) 读者注册优化：目录扫描节流 + 缓存，支持最大读者数阈值与预警。

里程碑 C（查询与性能）6) 属性倒排原型：对高频属性键建立轻量倒排，where 可识别“可下推”条件以减少页读取。7) 大页读写与 Rust/WASM 热点加速（评估项）。

—

六、阶段性结论

项目已从“原型”进阶为“具备上线潜力的 Alpha/Beta 过渡态”。如按上文 A/B 里程碑落地两到三项关键改造，即可在中型数据规模下获得更稳健的可伸缩性与可运维性。

—

工具调用简报

- 工具：repomix（本地打包结果复用）
- 输入摘要：读取 repomix-output.xml（87 文件，约 10k 行）；检索关键模块与测试锚点（persistentStore/pagedIndex/wal/queryBuilder 等）
- 关键参数：topFilesLength=10；基于全文 grep 定位 BEGIN/COMMIT/ABORT/manifest/fsync/rename/withSnapshot 等关键词
- 时间：本地分析 09-18 16:47 批次；未进行网络外呼
- 来源：repomix-output.xml + 仓库 tests/ 与 src/\* 源码
