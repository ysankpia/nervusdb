# T57: v2.0.0 正式版发布（Spec 6.3 实现）

## 1. Context

根据 `docs/spec.md` 6.3 章节，v2.0.0 是正式版的最低门槛，需要满足：
- [ ] 稳定的公开 Rust API（`nervusdb-v2` facade + `nervusdb-v2-query`）
- [ ] Cypher：至少支持基础读写闭环（CREATE/MATCH/WHERE/RETURN/LIMIT）——每项必须有测试
- [ ] 数据一致性：crash gate、恢复语义、tombstone/compaction 语义都被测试锁死
- [ ] 性能：提供基准与对比方法（不需要赢所有人，但要可重复、可解释）

当前状态：
- T54（属性存储层）进行中
- CREATE/DELETE/WHERE 已实现但测试覆盖不足
- 数据一致性测试需补充 tombstone 语义
- 性能基准需补充

## 2. Goals

1. **API 稳定性**：确保 `nervusdb-v2` 和 `nervusdb-v2-query` 公开 API 稳定
2. **测试覆盖**：所有基础 Cypher 操作（CREATE/MATCH/WHERE/RETURN/LIMIT/DELETE）必须有测试
3. **数据一致性**：补充 tombstone/crash recovery 语义测试
4. **性能基准**：提供可重复的性能测试方法

## 3. Non-Goals

- 不实现 MERGE/OPTIONAL MATCH 等高级 Cypher 语法
- 不实现属性索引
- 不实现多 label 支持

## 4. Proposed Solution

### 4.1 任务分解

```
T57.1 - 补充缺失测试 (3d)
  ├─ T57.1.1 - CREATE 完整测试（节点/边/属性）
  ├─ T57.1.2 - DELETE/DETACH DELETE 完整测试
  ├─ T57.1.3 - WHERE 过滤完整测试（比较/逻辑运算）
  └─ T57.1.4 - LIMIT 边界测试

T57.2 - 数据一致性测试补充 (2d)
  ├─ T57.2.1 - Tombstone 语义测试
  ├─ T57.2.2 - Crash recovery 属性恢复测试
  └─ T57.2.3 - Compaction 语义测试

T57.3 - API 稳定性审查 (1d)
  ├─ 审查 `nervusdb-v2` facade API
  ├─ 审查 `nervusdb-v2-query` API
  └─ 修复不一致/临时 API

T57.4 - 性能基准完善 (1d)
  ├─ 补充 v2 insert benchmark
  ├─ 补充 v2 query benchmark
  └─ 更新 V2_BENCH.md 文档
```

### 4.2 测试用例清单

#### CREATE 测试
```cypher
-- 基础节点
CREATE (n)
CREATE (n {name: 'Alice'})
CREATE (n {name: 'Alice', age: 30})

-- 基础关系
CREATE (a)-[:1]->(b)
CREATE (a)-[:1 {weight: 1.5}]->(b)

-- 复杂模式
CREATE (a {x: 1})-[:1]->(b {y: 2})

-- 多节点
CREATE (a), (b), (c)
```

#### DELETE 测试
```cypher
-- 基础删除
MATCH (a)-[:1]->(b) DELETE a
MATCH (a)-[:1]->(b) DELETE b

-- DETACH DELETE
MATCH (a)-[:1]->(b) DETACH DELETE a
DETACH DELETE a

-- 批量删除
MATCH (a) WHERE a.age < 18 DELETE a
```

#### WHERE 测试
```cypher
-- 比较运算
MATCH (a)-[:1]->(b) WHERE a.age > 25 RETURN b
WHERE a.name = 'Alice'
WHERE a.score >= 90
WHERE b.count != 0

-- 逻辑运算
WHERE a.age > 20 AND a.active = true
WHERE a.type = 'X' OR a.type = 'Y'
WHERE NOT a.disabled

-- 组合
WHERE a.age > 20 AND a.active = true OR a.admin = true
```

#### LIMIT 测试
```cypher
MATCH (n)-[:1]->(m) RETURN n, m LIMIT 5
RETURN 1 LIMIT 10
LIMIT 0 (边界)
LIMIT 大值 (边界)
```

### 4.3 数据一致性测试场景

#### Tombstone 语义
```rust
// 1. 创建节点后删除，应不可见
create_node(1, 0)
tombstone_node(node)
assert!(snapshot.resolve_external(node).is_none())

// 2. 创建带属性的节点，删除后属性不可访问
set_node_property(node, "name", "Alice")
tombstone_node(node)
assert!(snapshot.node_property(node, "name").is_none())

// 3. 创建边后删除，应不可见
create_edge(src, 1, dst)
tombstone_edge(src, 1, dst)
assert!(snapshot.neighbors(src, Some(1)).next().is_none())
```

#### Crash Recovery
```rust
// 1. 事务提交后崩溃，WAL replay 应恢复
set_node_property(node, "name", "Alice")
commit()
crash()
engine = reopen()
assert_eq!(snapshot.node_property(node, "name"), Some("Alice"))

// 2. 事务未提交崩溃，WAL replay 应回滚
set_node_property(node, "name", "Bob")
// crash without commit
engine = reopen()
assert!(snapshot.node_property(node, "name").is_none())
```

#### Compaction 语义
```rust
// 1. compaction 后数据不丢失
create_node(1, 0)
create_edge(node, 1, node2)
compact()
assert_eq!(snapshot.neighbors(node, Some(1)).count(), 1)

// 2. tombstoned 节点 compaction 后永久删除
tombstone_node(node)
compact()
assert!(snapshot.neighbors(node, None).next().is_none())
```

### 4.4 性能基准场景

| 场景 | 指标 | 预期 |
|-----|------|-----|
| 单节点创建 | ops/sec | > 10,000 |
| 单边创建 | ops/sec | > 10,000 |
| 单跳查询 (热) | P99 latency | < 1ms |
| 单跳查询 (冷) | P99 latency | < 10ms |
| 批量创建 (1000) | total time | < 1s |

## 5. Implementation Plan

### Phase 1: 测试补充 (Week 1)

**Day 1-2**: CREATE/DELETE 测试
- 扩展 `nervusdb-v2-query/tests/create_test.rs`
- 补充边界测试（空值、大值、特殊字符）

**Day 3**: WHERE 测试
- 扩展 `nervusdb-v2-query/tests/filter_test.rs`
- 补充比较/逻辑运算测试

**Day 4**: LIMIT 测试
- 在现有测试中添加 LIMIT 变体

### Phase 2: 数据一致性测试 (Week 2)

**Day 5-6**: Tombstone/Recovery 测试
- 新增 `nervusdb-v2-storage/tests/tombstone_semantics.rs`
- 扩展 `nervusdb-v2-storage/tests/m1_graph.rs`

**Day 7**: Compaction 语义测试
- 扩展 `nervusdb-v2-storage/tests/m2_compaction.rs`

### Phase 3: API 审查与修复 (Week 3)

**Day 8-9**: API 审查
- 审查所有 `pub` API
- 修复临时/不一致的 API
- 添加文档注释

**Day 10**: 最终测试验证
- 运行完整测试套件
- 运行 crash gate

### Phase 4: 性能基准 (Week 4)

**Day 11-12**: 性能测试
- 补充 `bench_v2` 测试用例
- 更新 `V2_BENCH.md`

**Day 13-14**: 文档与发布准备
- 更新 CHANGELOG.md
- 更新 README.md
- 准备 Release Note

## 6. Testing Strategy

### 6.1 单元测试

每个新增 API 必须有对应测试：
- `#[test]` 函数
- 测试文件位于 `nervusdb-v2-*/tests/` 或 `src/*/tests/`

### 6.2 集成测试

- `nervusdb-v2-query/tests/` 端到端测试
- 覆盖完整 query → storage → replay 链路

### 6.3 Crash Gate

- 运行 `cargo test -p nervusdb-v2-crash-test`
- 验证 100+ 次 crash 恢复

## 7. Risks

| 风险 | 影响 | 缓解 |
|-----|------|-----|
| T54 未完成 | 无法完成 WHERE/CREATE 测试 | T54 优先，或并行开发 |
| API 变更导致测试失败 | 进度延迟 | API 审查前置 |
| Crash test 不稳定 | CI 失败 | 增加超时和重试 |

## 8. Success Criteria

- [ ] 所有 CREATE/MATCH/WHERE/RETURN/LIMIT/DELETE 场景有测试覆盖
- [ ] Tombstone/Crash/Compaction 语义测试通过
- [ ] `cargo test` 全通过（所有 crate）
- [ ] Crash gate 100+ 次无失败
- [ ] 性能基准可重复执行
- [ ] API 文档完整（所有 `pub` 方法有注释）
- [ ] CHANGELOG.md 更新

## 9. Dependencies

- T54（属性存储层）- 必需
- 现有测试基础设施

## 10. References

- `docs/spec.md` 6.3 章节
- `nervusdb-v2-query/tests/create_test.rs`
- `nervusdb-v2-storage/tests/m1_graph.rs`
- `nervusdb-v2-storage/tests/m2_compaction.rs`
- `docs/perf/V2_BENCH.md`
