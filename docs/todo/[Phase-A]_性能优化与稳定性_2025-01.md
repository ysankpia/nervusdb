# [Phase-A] æ€§èƒ½ä¼˜åŒ–ä¸ç¨³å®šæ€§

**æ—¶é—´å‘¨æœŸ**ï¼š2025å¹´1æœˆç¬¬3-4å‘¨ï¼ˆ2å‘¨ï¼‰
**ä¼˜å…ˆçº§**ï¼šP0ï¼ˆç´§æ€¥ï¼‰
**ç›®æ ‡**ï¼šè§£å†³å½“å‰æ€§èƒ½ç“¶é¢ˆï¼Œæå‡ç³»ç»Ÿç¨³å®šæ€§

## ğŸ“Š ä»»åŠ¡æ¸…å•

### 1. æŸ¥è¯¢è¿­ä»£å™¨å®ç° â­â­â­â­â­

#### 1.1 é—®é¢˜åˆ†æ

- **ç°çŠ¶**ï¼š`QueryBuilder.all()` ä¸€æ¬¡æ€§åŠ è½½æ‰€æœ‰ç»“æœåˆ°å†…å­˜
- **å½±å“**ï¼šå¤§æ•°æ®é›†æŸ¥è¯¢å¯¼è‡´å†…å­˜æº¢å‡ºï¼Œæ— æ³•å¤„ç†è¶…å†…å­˜æ•°æ®
- **ç›®æ ‡**ï¼šå®ç°æµå¼æŸ¥è¯¢ï¼Œå†…å­˜å ç”¨ä» O(n) é™åˆ° O(1)

#### 1.2 å®æ–½æ–¹æ¡ˆ

```typescript
// ç°æœ‰å®ç°
class QueryBuilder {
  all(): FactRecord[] {
    return [...this.facts]; // ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰æ•°æ®
  }
}

// ç›®æ ‡å®ç°
class QueryBuilder {
  // è¿”å›å¼‚æ­¥è¿­ä»£å™¨
  async *[Symbol.asyncIterator](): AsyncIterator<FactRecord> {
    const pageSize = 1000;
    let offset = 0;

    while (true) {
      const batch = await this.fetchPage(offset, pageSize);
      if (batch.length === 0) break;

      for (const record of batch) {
        yield record;
      }

      offset += batch.length;
      if (batch.length < pageSize) break;
    }
  }

  // å…¼å®¹æ€§æ–¹æ³•
  async all(): Promise<FactRecord[]> {
    const results = [];
    for await (const record of this) {
      results.push(record);
    }
    return results;
  }
}
```

#### 1.3 å…·ä½“ä»»åŠ¡

- [ ] ä¿®æ”¹ `PagedIndexReader` æ”¯æŒæ¸¸æ ‡å¼è¯»å–
- [ ] å®ç° `QueryBuilder` çš„å¼‚æ­¥è¿­ä»£å™¨åè®®
- [ ] æ·»åŠ  `take()`, `skip()`, `batch()` ç­‰æµå¼æ“ä½œ
- [ ] ç¼–å†™æµå¼æŸ¥è¯¢çš„å•å…ƒæµ‹è¯•
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆ100ä¸‡æ¡æ•°æ®ï¼‰

#### 1.4 éªŒæ”¶æ ‡å‡†

- æŸ¥è¯¢100ä¸‡æ¡è®°å½•æ—¶ï¼Œå†…å­˜å³°å€¼ < 100MB
- æ”¯æŒ `for await (const record of query) {}` è¯­æ³•
- å‘åå…¼å®¹ç°æœ‰ `all()` æ–¹æ³•

---

### 2. å±æ€§ç´¢å¼•ä¸‹æ¨ â­â­â­â­

#### 2.1 é—®é¢˜åˆ†æ

- **ç°çŠ¶**ï¼š`where()` åœ¨è·å–æ‰€æœ‰æ•°æ®åè¿›è¡Œå†…å­˜è¿‡æ»¤
- **å½±å“**ï¼šé«˜é€‰æ‹©æ€§æŸ¥è¯¢ï¼ˆå¦‚1ä¸‡æ¡ä¸­æ‰¾10æ¡ï¼‰æ€§èƒ½æå·®
- **ç›®æ ‡**ï¼šæ„å»ºå±æ€§å€’æ’ç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶å…ˆè¿‡æ»¤å†è¯»å–

#### 2.2 å®æ–½æ–¹æ¡ˆ

```typescript
// æ–°å¢å±æ€§ç´¢å¼•ç»“æ„
class PropertyInvertedIndex {
  // propertyName -> value -> Set<nodeId>
  private nodeIndex: Map<string, Map<any, Set<number>>>;

  // æ·»åŠ ç´¢å¼•
  addNodeProperty(nodeId: number, propName: string, value: any) {
    if (!this.nodeIndex.has(propName)) {
      this.nodeIndex.set(propName, new Map());
    }
    const valueMap = this.nodeIndex.get(propName)!;
    if (!valueMap.has(value)) {
      valueMap.set(value, new Set());
    }
    valueMap.get(value)!.add(nodeId);
  }

  // æŸ¥è¯¢ç´¢å¼•
  findNodesByProperty(propName: string, op: '=' | '>' | '<', value: any): Set<number> {
    const result = new Set<number>();
    const valueMap = this.nodeIndex.get(propName);
    if (!valueMap) return result;

    if (op === '=') {
      return valueMap.get(value) || new Set();
    }

    // èŒƒå›´æŸ¥è¯¢
    for (const [v, nodeIds] of valueMap) {
      if ((op === '>' && v > value) || (op === '<' && v < value)) {
        for (const id of nodeIds) result.add(id);
      }
    }
    return result;
  }
}
```

#### 2.3 å…·ä½“ä»»åŠ¡

- [ ] å®ç° `PropertyInvertedIndex` ç±»
- [ ] æ·»åŠ  `whereProperty()` ç»“æ„åŒ–æŸ¥è¯¢API
- [ ] åœ¨å†™å…¥æ—¶è‡ªåŠ¨æ›´æ–°å±æ€§ç´¢å¼•
- [ ] å±æ€§ç´¢å¼•æŒä¹…åŒ–åˆ° `.propidx` æ–‡ä»¶
- [ ] æŸ¥è¯¢ä¼˜åŒ–å™¨è¯†åˆ«å¯ä¸‹æ¨çš„è°“è¯

#### 2.4 æµ‹è¯•ç”¨ä¾‹

```typescript
it('å±æ€§ç´¢å¼•æ˜¾è‘—æå‡è¿‡æ»¤æ€§èƒ½', async () => {
  // åˆ›å»º10000ä¸ªèŠ‚ç‚¹ï¼Œåªæœ‰10ä¸ª status='active'
  for (let i = 0; i < 10000; i++) {
    const status = i < 10 ? 'active' : 'inactive';
    db.addFact(
      {
        subject: `node:${i}`,
        predicate: 'type',
        object: 'User',
      },
      {
        subjectProperties: { status },
      },
    );
  }

  // ä¼ ç»Ÿwhereè¿‡æ»¤
  const t1 = Date.now();
  const r1 = db
    .find({})
    .where((r) => r.subjectProperties?.status === 'active')
    .all();
  const time1 = Date.now() - t1;

  // å±æ€§ç´¢å¼•è¿‡æ»¤
  const t2 = Date.now();
  const r2 = db.find({}).whereProperty('status', '=', 'active').all();
  const time2 = Date.now() - t2;

  expect(r1.length).toBe(10);
  expect(r2.length).toBe(10);
  expect(time2).toBeLessThan(time1 / 10); // è‡³å°‘10å€æå‡
});
```

---

### 3. Bugä¿®å¤æ¸…å• â­â­â­

#### 3.1 æ–‡ä»¶å¥æŸ„æ³„æ¼

- **ä½ç½®**ï¼š`src/maintenance/compaction.ts`, `src/storage/pagedIndex.ts`
- **é—®é¢˜**ï¼šéƒ¨åˆ†è·¯å¾„æœªä½¿ç”¨ try-finally å…³é—­æ–‡ä»¶
- **ä¿®å¤**ï¼š
  ```typescript
  // æ‰€æœ‰æ–‡ä»¶æ“ä½œéƒ½åº”è¯¥è¿™æ ·åŒ…è£…
  const handle = await fs.open(path, 'r');
  try {
    // æ“ä½œ
  } finally {
    await handle.close();
  }
  ```

#### 3.2 WALåµŒå¥—ABORTè¯­ä¹‰

- **ä½ç½®**ï¼š`src/storage/wal.ts`
- **é—®é¢˜**ï¼šåµŒå¥—æ‰¹æ¬¡çš„ABORTå¤„ç†ä¸æ­£ç¡®
- **ä¿®å¤**ï¼šå®ç°æ­£ç¡®çš„åµŒå¥—äº‹åŠ¡å›æ»šæ ˆ

#### 3.3 Manifestå†™å…¥æ€§èƒ½

- **ä½ç½®**ï¼š`src/storage/persistentStore.ts`
- **é—®é¢˜**ï¼šæ¯æ¬¡å†™å…¥éƒ½åŒæ­¥manifestå¯¼è‡´æ€§èƒ½ä¸‹é™
- **ä¿®å¤**ï¼šæ‰¹é‡æ›´æ–°manifestï¼Œå‡å°‘fsyncè°ƒç”¨

#### 3.4 å…·ä½“ä»»åŠ¡

- [ ] å®¡æŸ¥æ‰€æœ‰æ–‡ä»¶æ“ä½œï¼Œç¡®ä¿ try-finally æ¨¡å¼
- [ ] ä¿®å¤WALåµŒå¥—æ‰¹æ¬¡çš„è¾¹ç•Œè¯­ä¹‰
- [ ] ä¼˜åŒ–manifestæ›´æ–°é¢‘ç‡
- [ ] æ·»åŠ å›å½’æµ‹è¯•é˜²æ­¢é—®é¢˜é‡ç°

---

## ğŸ“ˆ æ€§èƒ½åŸºå‡†ç›®æ ‡

| æŒ‡æ ‡                   | å½“å‰å€¼ | ç›®æ ‡å€¼ | æå‡æ¯”ä¾‹ |
| ---------------------- | ------ | ------ | -------- |
| 100ä¸‡è®°å½•æŸ¥è¯¢å†…å­˜      | ~1GB   | <100MB | 90% â†“    |
| å±æ€§è¿‡æ»¤(1/1000é€‰æ‹©æ€§) | ~500ms | <50ms  | 90% â†“    |
| å†™å…¥ååé‡             | 10K/s  | 15K/s  | 50% â†‘    |
| æ–‡ä»¶å¥æŸ„æ³„æ¼           | å¶å‘   | 0      | 100%     |

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### æ€§èƒ½æµ‹è¯•

```bash
# åˆ›å»ºæ€§èƒ½æµ‹è¯•å¥—ä»¶
pnpm test:perf

# æµ‹è¯•é¡¹ç›®ï¼š
# 1. å¤§æ•°æ®é›†æµå¼æŸ¥è¯¢
# 2. å±æ€§ç´¢å¼•è¿‡æ»¤æ€§èƒ½
# 3. å¹¶å‘è¯»å†™å‹åŠ›æµ‹è¯•
# 4. å†…å­˜å ç”¨ç›‘æ§
```

### å›å½’æµ‹è¯•

```bash
# ç¡®ä¿ä¿®å¤ä¸å½±å“ç°æœ‰åŠŸèƒ½
pnpm test

# é‡ç‚¹å…³æ³¨ï¼š
# - tests/queryBuilder.test.ts
# - tests/property_index_performance.test.ts
# - tests/wal_*.test.ts
# - tests/compaction*.test.ts
```

## ğŸ“ ä»£ç å®¡æŸ¥è¦ç‚¹

1. **å†…å­˜ç®¡ç†**
   - é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§æ•°æ®
   - åŠæ—¶é‡Šæ”¾ä¸å†ä½¿ç”¨çš„å¯¹è±¡
   - ä½¿ç”¨ WeakMap/WeakSet ç®¡ç†ç¼“å­˜

2. **å¼‚æ­¥å¤„ç†**
   - æ­£ç¡®å¤„ç† async/await
   - é¿å…é˜»å¡äº‹ä»¶å¾ªç¯
   - åˆç†ä½¿ç”¨æ‰¹å¤„ç†

3. **é”™è¯¯å¤„ç†**
   - æ‰€æœ‰å¼‚æ­¥æ“ä½œéƒ½è¦æœ‰é”™è¯¯å¤„ç†
   - èµ„æºæ¸…ç†æ”¾åœ¨ finally å—
   - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

## âœ… å®Œæˆæ ‡å‡†

- [ ] æ‰€æœ‰å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½åŸºå‡†è¾¾æ ‡
- [ ] ä»£ç å®¡æŸ¥é€šè¿‡
- [ ] æ–‡æ¡£æ›´æ–°å®Œæˆ
- [ ] æ— æ–°å¢ lint è­¦å‘Š

## ğŸš€ ä¸‹ä¸€æ­¥

å®Œæˆ Phase-A åï¼Œè¿›å…¥ Phase-B å›¾æ•°æ®åº“æ ¸å¿ƒåŠŸèƒ½å¼€å‘ã€‚
