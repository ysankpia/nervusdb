# 实战 · 代码知识图谱

## 场景

将代码仓库中的文件、符号、依赖、测试覆盖关系写入 NervusDB，构建可查询的知识图谱，支撑影响分析与文档生成。

## 目标

- 自动扫描代码仓并写入三元组与属性
- 使用 QueryBuilder/GraphQL 查询影响链
- 结合 CLI 生成统计报表

## 准备

1. 安装 `ts-morph` 或语言分析工具，输出 JSON 格式的符号关系
2. 约定命名规范：`file:/path`、`symbol:FunctionName`、`test:Suite`
3. 创建数据库 `code.nervusdb`

## 数据导入流程

```ts
import { NervusDB } from 'nervusdb';
import { parseProject } from './analyzer';

const db = await NervusDB.open('code.nervusdb', {
  enableLock: true,
  enablePersistentTxDedupe: true,
});

db.beginBatch({ txId: 'import-2025-01', sessionId: 'analyzer' });

for (const fact of await parseProject('/repo')) {
  await db.addFact(
    { subject: fact.subject, predicate: fact.predicate, object: fact.object },
    {
      subjectProperties: fact.subjectProps,
      objectProperties: fact.objectProps,
      edgeProperties: fact.edgeProps,
    },
  );
}

db.commitBatch({ durable: true });
await db.flush();
await db.close();
```

## 核心关系设计

| 主体               | 谓词       | 客体                | 属性示例                             |
| ------------------ | ---------- | ------------------- | ------------------------------------ |
| `file:/src/app.ts` | `DEFINES`  | `symbol:App`        | `{ lang: 'ts', exports: 'default' }` |
| `symbol:App`       | `CALLS`    | `symbol:loadConfig` | `{ weight: 1 }`                      |
| `symbol:App`       | `OWNED_BY` | `team:core`         | `{}`                                 |
| `test:App.spec`    | `COVERS`   | `symbol:App`        | `{ coverage: 0.92 }`                 |

## 查询示例

### 1. 找出修改文件的影响范围

```ts
const impacted = await db
  .find({ subject: 'file:/src/app.ts', predicate: 'DEFINES' })
  .follow('CALLS')
  .follow('OWNED_BY')
  .distinct()
  .all();
```

### 2. GraphQL 按团队聚合测试覆盖率

```graphql
query Coverage($team: String!) {
  synapse {
    find(predicate: "OWNED_BY", object: $team) {
      subject
      coverage: follow(predicate: "COVERS") {
        edgeProperties
      }
    }
  }
}
```

### 3. 找出缺少测试的关键符号

```ts
const uncovered = await db
  .aggregate()
  .match({ predicate: 'DEFINES' })
  .groupBy(['object'])
  .leftJoin({ predicate: 'COVERS' })
  .having((group) => group.count('coverage') === 0)
  .execute();
```

## 运维建议

- 每次导入使用新 `txId`，失败自动重放
- 定期执行 `nervusdb auto-compact code.nervusdb --auto-gc`
- 使用 `nervusdb stats --txids` 监控导入频率

## 可视化

- 将 `nervusdb dump` 输出的 NDJSON 输入 `Graphviz` 或 `Neo4j Bloom`
- 或使用外部工具将结果转换成 `dot`/`gexf`

## 延伸

- 与 `repomix` 结合，生成仓库上下文文件
- 将查询结果导入文档生成流程（如 ADR、影响分析）
