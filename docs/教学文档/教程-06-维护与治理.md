# 教程 06 · 维护与治理（Auto-Compact / GC / Repair / Stats）

## 总览

SynapseDB 将数据与索引分离，并提供成套的治理工具：

- 统计：`synapsedb stats <db>`（triples/epoch/pages/tombstones/walBytes/txIds/lsm/hotness）
- 自动合并：`synapsedb auto-compact <db> [...options]`（支持 dry-run）
- 页面级 GC：`synapsedb gc <db> [--no-respect-readers]`
- 修复/自检：`synapsedb check|repair <db> [--strict|--fast]`
- 热点：`synapsedb hot <db> [--order=SPO] [--top=10]`
- 导出：`synapsedb dump <db> <order> <primary>`

## Auto-Compact（增量 / 重写）

示例：仅对 `SPO` 顺序，阈值=2，热度阈值=1，仅 Top1，并自动 GC：

```bash
synapsedb auto-compact demo.synapsedb \
  --mode=incremental --orders=SPO --min-merge=2 --hot-threshold=1 --max-primary=1 --auto-gc
```

选项要点：

- `--mode=incremental|rewrite`
- `--orders=SPO,POS,...`
- `--min-merge=N`：某主键拥有多页达到 N 时入选
- `--tombstone-threshold=R`：墓碑占比阈值
- `--hot-threshold=H --max-primary=K`：热度驱动 + TopK 限制
- `--includeLsmSegments[Auto]`：满足阈值自动并入 LSM 段
- `--dry-run`：仅输出决策不落盘

## GC（页面级）

- 清理增量重写后不再被引用的 `orphans`
- 建议在有读者时启用尊重策略（默认尊重）：避免中断长查询

## Repair（修复）

- `check --strict` 定位损坏页/顺序
- `repair --fast`：按页快速修复，仅替换坏页映射
- 按序重写：针对坏顺序全量重建页文件
- 无损坏则全量重建（保留 tombstones）

## Stats / Hotness / Readers

- `stats` 输出 epoch/页/墓碑/WAL/txIds/lsm 等
- `hot` 输出每个顺序下 primary 热度 TopN
- `readers.json`：跨进程读者登记，Auto-Compact/GC 可尊重读者跳过
