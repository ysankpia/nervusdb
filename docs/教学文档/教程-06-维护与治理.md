# 教程 06 · 维护与治理

## 目标

- 掌握日常巡检、压实、GC、修复的操作组合
- 理解读者尊重策略与事务观测工具
- 构建可自动化的治理流程

## 前置要求

- 熟悉 CLI 命令与索引机制

## 日常巡检

```bash
nervusdb stats demo.nervusdb --summary
nervusdb hot demo.nervusdb --top=10
```

输出重点：

- `triples`、`tombstones`：数据量与墓碑比
- `orders.*.multiPagePrimaries`：哪些主键跨多页
- `hotness.top`：热点主键
- `walBytes`：WAL 大小

## 自动压实

```bash
nervusdb auto-compact demo.nervusdb \
  --mode=incremental \
  --orders=SPO,POS \
  --min-merge=2 \
  --hot-threshold=1.1 \
  --max-primary=5 \
  --auto-gc
```

- 根据热度、页数、墓碑比例决定增量或 rewrite
- 自动执行 GC，清理孤页
- 遇到活跃读者会跳过，日志中有提示

## 手动压实与 GC

```bash
nervusdb compact demo.nervusdb --orders=SPO --page-size=1024 --compression=brotli:4
nervusdb gc demo.nervusdb --respect-readers
```

- rewrite 模式适合冷数据全量压缩
- `--respect-readers` 确保读者安全；必要时可关闭（风险高）

## 修复与诊断

```bash
nervusdb check demo.nervusdb --strict
nervusdb repair demo.nervusdb --fast
nervusdb repair-page demo.nervusdb SPO 123
```

- `check --strict`：校验索引完整性、manifest、WAL 尾部
- `repair --fast`：按页快速修复；若失败会尝试整库 rebuild
- `repair-page`：针对单个 primary 重建索引页

## 事务观测

```bash
nervusdb txids demo.nervusdb --list=20
nervusdb txids demo.nervusdb --since=60
nervusdb txids demo.nervusdb --session=ingest-service
```

- 查看最近事务、按时间过滤、按 session 聚合
- `--clear` 可清空注册表（需确保幂等不受影响）

## 推荐治理流程

1. 每日：`stats --summary`、`hot --top=10`
2. 每周：`auto-compact` + `gc`
3. 每月：`compact --mode=rewrite`（冷数据）
4. 变更或故障后：`check --strict`、`repair`
5. 自动化：以 cron 或 CI 执行上述流程，并记录日志

## 脚本化样例

```bash
#!/usr/bin/env bash
set -euo pipefail
DB=$1
nervusdb stats "$DB" --summary > logs/$(date +%F)-stats.log
nervusdb auto-compact "$DB" --mode=incremental --hot-threshold=1.2 --auto-gc
nervusdb txids "$DB" --since=1440 > logs/$(date +%F)-txids.log
```

## 常见问题

| 场景                    | 原因                   | 解决                                            |
| ----------------------- | ---------------------- | ----------------------------------------------- |
| auto-compact 提示有读者 | 存在活跃快照           | 等待读者结束，或排查长时间查询                  |
| repair 失败             | 索引严重损坏或权限限制 | 手动备份后执行 `--rebuildIndexes`，检查文件权限 |
| stats 输出为空          | 路径错误或文件损坏     | 确认数据库路径，执行 `nervusdb check`           |

## 延伸阅读

- [docs/使用示例/05-维护治理-示例.md](../使用示例/05-维护治理-示例.md)
- [docs/使用示例/09-嵌入式脚本与自动化-示例.md](../使用示例/09-嵌入式脚本与自动化-示例.md)
- [教程 07 · 存储格式与持久化](教程-07-存储格式与持久化.md)
