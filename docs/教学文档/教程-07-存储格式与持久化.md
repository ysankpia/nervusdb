# 教程 07 · 存储格式与持久化

## 主数据文件（`<name>.synapsedb`）

- 文件头（64B）：魔数 `SYNAPSEDB`、版本 `2`
- 区段：`dictionary`（字典）、`triples`（主三元组）、`indexes(staging)`（暂存索引镜像）、`properties`（属性）

## 分页索引目录（`<name>.synapsedb.pages/`）

- `SPO.idxpage`/`SOP.idxpage`/...：页文件（可选择 `brotli` 压缩）
- `index-manifest.json`：`pageSize/compression/lookups/tombstones/epoch/orphans`
- `hotness.json`：热度计数（带半衰衰减）
- `readers/`：读者登记文件（每进程独立 reader 文件）
- `lsm-manifest.json`：LSM-Lite 段清单（实验），可并入并清空

## WAL（`<name>.synapsedb.wal`）

- 记录 add/delete/props 及批次提交
- 崩溃恢复时重放，遇到不完整记录按 `safeOffset` 截断

## 刷盘（`db.flush()`）

- 持久化字典/三元组/属性
- 合并分页索引（增量/整序）并写 manifest
- 写入热度计数（半衰处理）
- LSM-Lite 段落盘（实验）
- 重置 WAL
