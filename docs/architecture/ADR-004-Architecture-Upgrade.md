# ADR-004: 架构升级：从内存中心到磁盘中心的持久化模型

## 状态

已接受 (Accepted) - 阶段一已完成 (2025-10-17)

## 日期

- 提议: 2025-10-16
- 接受: 2025-10-17（阶段一完成）

## 背景

通过对当前代码库的全面审查，我们发现 NervusDB 的核心架构存在一个根本性的设计瓶颈。当前系统在行为上是一个“穿着磁盘引擎外套的内存数据库”。

具体表现为：

1.  **容量受限于内存**：`PersistentStore.open` 方法在启动时会完整加载整个数据库文件（字典、属性、索引）到内存中，导致数据库的最大尺寸受限于服务器的物理内存。
2.  **启动速度慢**：随着数据量增长，全量加载数据到内存的过程会变得越来越慢，影响可用性。
3.  **写性能衰减**：`flush` 操作本质上是将内存中的数据结构完整序列化并重写到磁盘，这导致了 `O(N)` 的写放大问题。数据库越大，每次写入的成本越高。

这个核心缺陷限制了项目的可伸缩性，使其无法与业界主流的“强大”图数据库（如 Neo4j, ArangoDB）在同一维度竞争，也为上层应用（如 MCP）的稳定性埋下了隐患。

## 决策

我们决定实施一次彻底的架构升级，将 NervusDB 从“内存中心模型”重构为“磁盘中心模型”。

此决策将通过一个分阶段的、系统性的演进路线图来执行：

1.  **阶段一：核心重构 - 成为真正的磁盘数据库 (P0)**
    - 将分页索引 (`PagedIndex`) 确立为数据的“事实之源”（Source of Truth）。
    - `PersistentStore.open` 不再加载全量数据，仅加载元数据和必要的缓存。
    - 实现真正的“增量 Flush”，`flush` 操作仅将内存中的增量数据追加到磁盘索引中。
    - 改造查询引擎，使其直接从磁盘读取数据，仅合并少量内存增量。
    - 将属性存储 (`PropertyStore`) 也改造为基于磁盘的索引结构。

2.  **阶段二：查询革命 - 标准化与智能化 (P1)**
    - **标准化查询语言**：将 **openCypher** 从实验性插件提升为项目的一等公民和主要查询接口。废弃或降级私有的链式查询 API。
    - **构建查询优化器**：开发一个基于成本的查询优化器（Cost-Based Optimizer），能够根据索引统计信息选择最优执行计划。
    - **实现全流式执行**：确保从索引扫描到最终结果返回，整个查询过程都基于迭代器（Iterator）模型，以最小化内存占用。

3.  **阶段三：高级特性 - 扩展数据库能力 (P2)**
    - 集成全文检索（FTS）到 Cypher 查询中。
    - 重构图算法库，使其能在基于磁盘的 `GraphView` 上运行，以支持大规模图分析。
    - 在性能分析的基础上，将新的性能热点（如页面处理、B-Tree 操作）用 Rust 重写并编译为 WASM 模块。

4.  **阶段四：生态与运维 - 成为完整产品 (P3)**
    - 增强 CLI 工具，提供面向新架构的监控和诊断能力。
    - 开发可视化工作台，用于执行 Cypher 查询和图形化展示结果。
    - 提供主流语言的标准化驱动程序。

## 理由

1.  **解决根本性瓶颈**：这是唯一能够解决可伸缩性问题的方案。只有这样，NervusDB 才能处理远超内存的大型数据集，成为一个严肃的工业级产品。

2.  **拥抱“好品味”的设计**：从一个充满“特殊情况”（内存与磁盘的双重状态）的复杂模型，转向一个简单、一致、可预测的磁盘中心模型，是架构上的“好品味”。

3.  **务实的工程路径**：在脆弱的地基上构建上层应用（MCP）是危险且低效的。优先加固地基（数据库核心），可以避免未来的大规模重构和技术债务。这是对项目长期健康发展的最大投资。

4.  **标准化是必由之路**：采用 openCypher 作为标准查询语言，可以极大地降低新用户的学习成本，利用现有的生态系统和工具，并为查询优化提供一个清晰、声明式的目标。这是数据库走向成熟的标志。

## 后果

### 优势

- **无限扩展能力**：数据库容量将只受限于磁盘空间，不再受限于物理内存。
- **卓越的性能**：获得亚秒级的启动速度和稳定、高效的写入性能。
- **坚实的技术基础**：为所有上层应用（MCP）和高级功能（图算法、FTS）提供一个稳定、可扩展的运行平台。
- **提升产品价值**：通过拥抱行业标准和提供强大的性能，使项目具备与商业数据库竞争的潜力。

### 劣势与缓解措施

- **高昂的开发成本**：这是一次伤筋动骨的重构，需要投入大量、集中的开发时间。
  - **缓解措施**：在阶段一和阶段二期间，**冻结所有非核心的新功能开发**，将团队精力聚焦于此。同时，**高度依赖并持续完善现有的全面测试套件**（尤其是崩溃注入、并发和隔离性测试），作为重构过程中的安全网。

- **短暂的功能停滞**：在核心重构期间，用户不会看到新的上层功能。
  - **缓解措施**：通过这份 ADR 和项目路线图，明确地与社区（或团队）沟通，解释短期投入是为了换取长期的巨大回报。

- **引入错误的风险**：任何大规模重构都有可能引入难以发现的 bug。
  - **缓解措施**：在测试中增加针对磁盘 I/O、数据一致性、页面损坏和恢复场景的专项测试。在每个子步骤完成后，进行严格的回归测试。
