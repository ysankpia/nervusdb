# 测试分层与运行指南

本项目已将测试用例按“类型 × 模块”进行分层组织，遵循“镜像 src 结构”的原则，便于快速定位与按域运行。

## 目录结构

```
tests/
├─ unit/                 # 单元测试（纯函数/最小依赖）
│  ├─ storage/
│  ├─ query/
│  ├─ graph/
│  └─ connection/
├─ integration/          # 集成测试（模块间/文件系统）
│  ├─ storage/
│  ├─ query/
│  │  ├─ path/
│  │  └─ standards/     # Cypher/Gremlin/GraphQL
│  └─ maintenance/
├─ system/               # 系统级/端到端（并发/崩溃恢复/快照）
├─ performance/          # 基准与大数据性能
└─ types/                # TypeScript 类型测试
```

Vitest 配置保持 `include: ["tests/**/*.test.ts"]`，无需修改即可发现新位置用例。

## 运行示例

- 运行全部：`pnpm test`
- 仅运行存储集成：`pnpm vitest run tests/integration/storage`
- 仅运行查询规范：`pnpm vitest run tests/integration/query/standards`
- 仅运行系统级：`pnpm vitest run tests/system`

## 命名与导入规范

- 测试文件统一使用后缀：`*.test.ts`
- 目录命名与源码镜像：`tests/<层级>/<模块>(/子模块)`
- 统一使用别名导入：`@ → src/`（示例：`import { SynapseDB } from '@/synapseDb'`）
  - 禁止使用相对到 `src/` 的路径（如 `../src/*.js`），以避免目录调整导致导入失效。

## 迁移注意事项（给新用例作者）

- 纯函数/数据结构 → 放入 `unit/` 相应模块目录
- 涉及文件系统/打开数据库 → 放入 `integration/`
- 并发、崩溃注入、快照一致性 → 放入 `system/`
- 性能基线或大规模插入 → 放入 `performance/`
- Graph 相关（标签/路径）分别落位 `graph/`、`query/path/`

## 清理与隔离

- 涉及文件系统的集成与系统测试需确保：
  - 使用 `mkdtemp()` 创建独立工作目录
  - 用例 `afterEach/afterAll` 中删除 `*.pages/readers` 及临时目录
  - 优先采用已有的重试清理模板，避免竞态残留

### 临时文件策略（统一约定）

- 推荐：使用 `tests/helpers/tempfs.ts` 提供的 `makeWorkspace()/cleanupWorkspace()` 在 OS 临时目录下创建与清理工作区，避免污染仓库根目录。
- 过渡兼容：为兼容历史用例，测试运行结束后会通过全局清理钩子自动移除仓库根目录下匹配模式 `tmp-*.synapsedb` 及其关联文件：
  - `${name}.pages/`、`${name}.wal`、`${name}.lock`
- 新增用例请勿直接在仓库根目录创建数据库文件；如确需临时文件，请遵循上述命名约定或改用临时工作区。

如对分层或归属有疑问，可在 PR 中标注，评审时共同调整。
